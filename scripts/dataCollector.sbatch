#!/bin/bash
#
# SBATCH wrapper to launch scripts/glaDataCollection.py and notify on completion.
# SLURM Script for GitHub data collection
#
# Usage:
#   `sbatch scripts/collect_data.sbatch`
#
# Slurm directives:
# - single node, 5 CPUs, 30 GB RAM, 100 hours, email notifications

#SBATCH --job-name=github_data_collection
#SBATCH --output=/info/etu/m2/s2403274/MLOps_Bigdata_Projet/Github-Language-Analysis/logs/collection_%j.log
#SBATCH --error=/info/etu/m2/s2403274/MLOps_Bigdata_Projet/Github-Language-Analysis/logs/collection_%j.err
#SBATCH --time=100:00:00
#SBATCH --mem=30G
#SBATCH --cpus-per-task=5
#SBATCH --mail-type=ALL
#SBATCH --mail-user=kerryghan.relot.etu@univ-lemans.fr

echo "üìà Github Language Analysis - Collecte de donn√©es GitHub (SLURM)"
echo "=========================================================="
echo "Job ID: $SLURM_JOB_ID"
echo "Node: $SLURM_NODELIST"
echo "Start time: $(date)"
echo ""

# D√©terminer la racine du projet
# SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="/info/etu/m2/s2403274/MLOps_Bigdata_Projet/Github-Language-Analysis"

cd "$PROJECT_ROOT" || {
    echo "‚ùå Impossible de se placer √† la racine du projet"
    exit 1
}

# Cr√©er le dossier de logs avec chemin absolu
mkdir -p "$PROJECT_ROOT/logs"


# Lancer la collecte via le script collect_github_data.sh
echo "üöÄ Lancement de la collecte de donn√©es..."
echo "‚è±Ô∏è  Dur√©e maximale: 100 heures"
echo "‚è±Ô∏è  D√©but: $(date)"
echo ""

# Ex√©cuter le script de collecte
source ~/miniconda3/etc/profile.d/conda.sh
conda activate superman

# Setting variable to launch python script
PYTHON=~/miniconda3/envs/superman/bin/python
SCRIPT=$PROJECT_ROOT/scripts/glaDataCollection.py

${PYTHON} "${SCRIPT}"

EXIT_CODE=$?

# R√©sum√© final
echo ""
echo "=========================================================="
echo "üìä Fin de la collecte"
echo "‚è±Ô∏è  Fin: $(date)"
echo "Exit code: $EXIT_CODE"
echo ""

echo ""
echo "üéâ Job SLURM termin√©!"
echo "üí° Consultez les logs dans: logs/collection_${SLURM_JOB_ID}.out"

exit $EXIT_CODE